# Release plan — Stage 1 (file-based sync) — Pre‑Resolved (2026‑01‑19)

Цель: довести server-less file-based sync до “пользовательского качества” без добавления новых провайдеров.

Статус: **предварительно выполнено**. Возврат к доработкам — после добавления Google Drive + OneDrive (Stage 1.1).

## Scope
- Провайдеры: Dropbox, Yandex Disk, WebDAV/SMB (как fallback для NAS).
- Протокол: `event_log.json`, `state.json`, `meta.json`, `books_index.json`.
- Merge: LWW по `updatedAt` (см. `docs/conflict_policy.md`).

## Что считаем done (Definition of Done)
- UI: в настройках виден статус синхронизации (последний успех/ошибка), доступны “Повторить”, “Переподключить”, “Проверить”.
- UX: подключение возможно без ручного ввода OAuth keys в типовом сценарии; NAS (WebDAV/SMB) подключается по URL/логину/паролю или по пути шара.
- Надёжность: request/transfer таймауты разделены; есть retry/backoff на сетевые ошибки; при ошибках 4xx автосинк отключается с понятным сообщением.
- Безопасность логов: токены/пароли/Basic auth не попадают в логи; URI с userinfo редактируются.
- Диагностика: пользователю доступен путь к логу и экспорт лога.

## Release checklist (P0)
- UI: понятный статус синхронизации (последний успех/ошибка), кнопки “Повторить” и “Переподключить”.
- UX: дружелюбное подключение (без требований к пользователю про OAuth keys).
- Надёжность: таймауты разделены на request/transfer, лимит параллелизма на загрузки, retry/backoff на сетевые ошибки.
- Безопасность логов: токены/пароли/Basic auth не пишутся в лог.
- Диагностика: путь к логу виден пользователю + экспорт лога (или “копировать путь”).

## Nice-to-have (P1)
- (Отложено) Опциональное client-side шифрование sync-файлов (пароль/ключ на устройстве).
- Миграция путей/форматов (legacy paths) без ручных действий: чтение legacy путей + запись в новый путь (без ручных переносов).

## Changelog (high-level)
- Добавлен локальный file-based sync engine (upload/download/merge по LWW) и единый `SyncAdapter` для провайдеров.
- Реализованы провайдеры Dropbox, Yandex Disk и NAS (WebDAV/SMB fallback), включая тесты адаптеров.
- Добавлены UI‑элементы статуса синхронизации, ручной запуск синка, переподключение и удаление remote sync‑файлов.
- Добавлена диагностика: путь к `cogniread.log`, экспорт лога, редактирование секретов в логах.

## Acceptance criteria
- Fresh install + подключение любого из провайдеров → первая синхронизация проходит без крашей.
- При отсутствии файлов в облаке (`404`) приложение не показывает ошибок пользователю (использует пустые данные).
- Загрузка нескольких книг в облако проходит без таймаутов на обычном соединении (порог: 2–5 минут).
- При сетевой ошибке автосинк отключается/показывает понятное сообщение и предлагает восстановление.

## Инструкция ручной проверки (быстро)
Использовать `docs/test_plan_stage1_sync.md`.
1) Fresh install / сброс синка (debug): Настройки → Диагностика → “Сбросить (тест)”.
2) Подключить провайдера: Настройки → Синхронизация → “Подключить”.
3) Запустить: “Синхронизировать сейчас” и пройти AC1–AC4.
4) При проблемах: Настройки → Диагностика → “Экспорт лога” и приложить `cogniread.log`.
