# Архив документов

Этот файл содержит исторические документы, собранные в одном месте и сгруппированные по этапам.

## Навигация
- Этап MVP0: `docs/plan_mvp0.md`, `docs/dod.md`, `docs/test_plan.md`
- Этап MVP1: `docs/plan_mvp1.md`
- Этап Stage 1 (file-based sync): `docs/sync_file_based_issues.md`

---
## Этап MVP0

### docs/plan_mvp0.md

# План разработки CogniRead — MVP0 (локальный) — по дням

Статус: **завершено** (документ сохранен как история).

Этот план рассчитан на формат: **1 день = 1 PR в `main`**.

## Принципы
- Один день = один PR с понятным diff и проверкой: `flutter analyze` + `flutter test`.
- “Готово” = критерии приёмки + ручной сценарий + тест/проверка.
- Облако/AI **не делаем** в MVP0 (это MVP1/MVP2).

## Definition of Done для каждого дня (коротко)
- [ ] PR в `main`
- [ ] `flutter analyze` — без ошибок (желательно без предупреждений)
- [ ] `flutter test` — зелёный
- [ ] В PR описаны 1–3 ручных сценария проверки
- [ ] Документация обновлена, если менялся scope/архитектура

---

## День 3 — Стабилизация репозитория и границ MVP0
Чеклист:
- [x] Привести `assets/` в порядок: создать папку `assets/` **или** убрать `assets:` из `pubspec.yaml` до появления ресурсов.
- [x] Привести `README.md` и `STATE.md` в соответствие фактической структуре.
- [x] В `docs/spec_mvp.md` разделить scope на **MVP0 / MVP1 / MVP2**.
- [x] В `docs/dod.md` уточнить DoD для PR (линт/тесты/ручная проверка/доки).
- ✅ Контроль: `flutter analyze` и `flutter test` зелёные.

LLM-контроль (D3):
- “Найди противоречия в `spec_mvp.md`. Сформируй 7–10 проверяемых критериев приёмки для MVP0.”

---

## День 4 — Контракты и выбор пакетов для импорта
Чеклист:
- [x] Зафиксировать в `docs/decisions.md` выбор:
  - file picker (desktop/macOS),
  - пути хранения (app-managed storage),
  - epub parsing (минимум метаданные),
  - локальное хранилище (DB/kv).
- [x] Подключить зависимости в `pubspec.yaml`.
- [x] Ввести интерфейсы: `StorageService`, `BookRepository`, модели (Book + DTO/record).
- ✅ Контроль: сборка и тесты проходят; есть хотя бы 1 unit-тест на критический кусок (валидация/Result).

LLM-контроль (D4):
- “Риск-ревью по macOS sandbox и работе с путями/доступами.”

---

## День 5 — UI импорта (выбор файла) + валидация
Чеклист:
- [x] Реальный выбор файла EPUB из LibraryScreen.
- [x] Корректная обработка cancel.
- [x] Валидация: расширение/существование/читаемость.
- [x] Показ ошибок пользователю (snackbar/dialog).
- ✅ Контроль: cancel / не epub / epub ok — отрабатывают корректно.

---

## День 6 — Storage: копирование в управляемую директорию приложения
Чеклист:
- [x] Копирование выбранного EPUB в app-managed storage.
- [x] Конфликты имён: безопасное переименование (суффикс/хэш).
- [x] Атомарность: temp → rename (по возможности).
- ✅ Контроль: исходный файл можно удалить; импортированная книга остаётся доступной.

LLM-контроль (D6):
- “Security review: плохие имена файлов, path traversal, отмена/ошибки доступа.”

---

## День 7 — Извлечение метаданных EPUB (минимум)
Чеклист:
- [x] Извлечь `title` (обязательно), `author` (желательно).
- [x] Fallback: имя файла, если метаданные отсутствуют.
- ✅ Контроль: минимум 3 разные книги → корректный title.

---

## День 8 — Persistence библиотеки (локально)
Чеклист:
- [x] Сохранение списка книг (id, title, author, localPath, addedAt).
- [x] Загрузка при старте.
- [x] Удаление книги: удалить запись + файл.
- ✅ Контроль: перезапуск сохраняет библиотеку; удаление реально удаляет файл.

LLM-контроль (D8):
- “Проверь схему данных: что нужно добавить для позиции/заметок/прогресса.”

---

## День 9 — Reader MVP: открыть и реально читать
Чеклист:
- [x] Открытие книги по `bookId`.
- [x] Реальный рендер содержимого (минимальный, без идеальной пагинации допустимо).
- [x] Экран загрузки/ошибки (битый файл/нет доступа).
- ✅ Контроль: читается хотя бы первая глава/текст, без падений.

---

## День 10 — TOC и навигация по главам
Чеклист:
- [x] Получить оглавление (TOC).
- [x] Переход по главам.
- ✅ Контроль: переходы устойчивые, нет “пустых экранов”.

---

## День 11 — Сохранение позиции чтения
Чеклист:
- [x] Сохранять последнюю позицию (глава + якорь/смещение по возможностям движка).
- [x] Восстанавливать при открытии.
- ✅ Контроль: закрыть/открыть → продолжает с места.

LLM-контроль (D11):
- “Предложи устойчивый формат позиции и тест-кейсы (смена шрифта/окна/темы).”

Предложение (D11):
- Формат позиции: `{bookId, chapterHref | chapterIndex, fragmentId?, offsetPx?, progressPct?, updatedAt}`.
  - `chapterHref` (или `chapterIndex` как fallback).
  - `fragmentId` = якорь в TOC/HTML при наличии.
  - `offsetPx` = смещение от начала главы в пикселях (fallback).
  - `progressPct` = общий прогресс по книге (fallback при больших визуальных изменениях).
- Тест-кейсы:
  - Смена размера окна (desktop): позиция сохраняется и восстанавливается в той же главе.
  - Скролл в середине/конце главы → закрыть/открыть → та же зона.
  - Переход между главами через TOC → сохранить → восстановить.
  - Валидация fallback: если якорь/fragment отсутствует, используем chapter + offset/progress.

---

## Дальше (после MVP0, отдельный этап)
- Поиск по книге
- Highlights/bookmarks
- Notes + экспорт
- Затем MVP1 (sync) и MVP2 (AI) — отдельными фазами

---
### docs/dod.md

# Definition of Done (DoD) — MVP0

Статус: **история/архив** (использовалось на этапе MVP0).

## MVP0-фичи
- Реализованы пользовательские сценарии без критичных дефектов.
- Smoke-тесты проходят локально и в CI.
- Документация обновлена (минимум: README и docs/spec_mvp.md).
- CI проходит полностью; команды CI воспроизводимы локально.
- Логи/ошибки видимы в консоли (без внешних сервисов).
- PR прошел ревью согласно docs/workflow.md (минимум 1 аппрув).

## Клиент
- Запуск приложения стабилен; Library → Reader работает без падений.
- Структура проекта и слоев соответствует договоренностям.

## DoD для PR
- `flutter analyze` без предупреждений/ошибок.
- `flutter test` проходит.
- Ручная проверка: запуск приложения и базовая навигация Library → Reader.
- Обновлены документы, если менялись требования/структура/поведение.

## Релиз
- Версионирование и changelog обновлены при необходимости.

---
### docs/test_plan.md

# Test Plan — MVP0 (local-only)

Статус: **история/архив** (план для этапа MVP0).

## Минимальный набор тестов

### Widget tests
- Стартовый экран Library отображает пустое состояние.
- Нажатие "Импортировать EPUB (заглушка)" добавляет запись в список.
- Тап по записи открывает Reader и показывает заголовок книги.

### Unit tests
- Result обрабатывает успех/ошибку корректно.
- BookRepositoryImpl оборачивает исключения в Result.

### Smoke
- `flutter test` проходит на macOS в CI.

---
## Этап MVP1

### docs/plan_mvp1.md

# План MVP1 — локальный импорт

Статус: **завершено** (функциональность реализована, документ оставлен как история).

Основание: `docs/spec_mvp.md` (раздел MVP1).

## Цели
- Реальный импорт EPUB через picker.
- Сохранение файла в app-managed storage.
- Парсинг метаданных (title/author/cover).
- Базовое хранение в локальной библиотеке.

## День 1 — Импорт EPUB
Чеклист:
- [x] File picker подключен для desktop (macOS).
- [x] Валидация пути/расширения/размера файла.
- [x] Копирование файла в app-managed storage (sandbox).
- [x] Дедупликация по хэшу.
- ✅ Контроль: импорт одного EPUB добавляет запись без ошибок.

## День 2 — Метаданные
Чеклист:
- [x] Извлечь title/author из EPUB.
- [x] Обработка пустых/битых метаданных (fallback на имя файла).
- [x] Сохранение метаданных в LibraryStore.
- ✅ Контроль: название и автор отображаются в библиотеке.

## День 3 — Обложка
Чеклист:
- [x] Извлечь cover (если есть) и сохранить локально.
- [x] Хранить путь к cover в записи книги.
- [x] Показать cover в библиотеке (fallback: генератор обложки).
- ✅ Контроль: при наличии cover она отображается, иначе fallback.

## День 4 — Хранение и устойчивость
Чеклист:
- [x] Проверка/миграция схемы LibraryStore под новые поля.
- [x] Очистка/удаление книги удаляет файл и обложку.
- [x] Обработка отсутствующих файлов (показывать ошибку/обновить запись).
- ✅ Контроль: перезапуск не ломает библиотеку.

## Acceptance criteria (MVP1)
- `flutter run -d macos` импортирует EPUB через picker.
- Импортированный файл сохраняется в app-managed storage.
- В библиотеке отображаются title/author и cover (если есть).
- Удаление книги удаляет файл и cover с диска.

---
## Этап Stage 1 (file-based sync)

### docs/sync_file_based_issues.md

# File-based Sync — технический план задач

Статус: **история/архив**. Google Drive/OneDrive отложены.

Формат: 1 issue ≈ 1 PR ≈ 1 день.

---
## 1) Sync adapter interface (client)
**Цель:** единый интерфейс для провайдеров (Dropbox/Yandex/NAS; Drive/OneDrive отложены).

**Checklist**
- [x] Интерфейс `SyncAdapter` (list/get/put/delete).
- [x] Обёртки для OAuth‑токенов и ошибок.
- [x] Моки для тестов.

---
## 2) File format v1
**Цель:** финализировать структуру файлов `event_log.json`, `state.json`, `meta.json`.

**Checklist**
- [x] Версионирование (`schemaVersion`).
- [x] Формат cursors + updatedAt.
- [x] Политика merge (LWW).

---
## 3) Local sync engine
**Цель:** локальная синхронизация через файлы.

**Checklist**
- [x] Upload: сериализовать event log → cloud.
- [x] Download: читать файлы → merge по LWW.
- [x] Conflict handling: idempotent events.

---
## 4) Provider: Google Drive (отложено)
**Цель:** OAuth + CRUD файлов синка.

**Checklist**
- [ ] OAuth flow.
- [ ] CRUD файлов синка.
- [ ] Тест на upload/download.

---
## 5) Provider: Dropbox
**Цель:** второй провайдер.

**Checklist**
- [x] OAuth flow.
- [x] CRUD файлов синка.
- [x] Тест на upload/download.

---
## 6) Provider: OneDrive (отложено)
**Цель:** OAuth + CRUD файлов синка.

**Checklist**
- [ ] OAuth flow.
- [ ] CRUD файлов синка.
- [ ] Тест на upload/download.

---
## 7) Provider: Yandex Disk
**Цель:** четвёртый провайдер.

**Checklist**
- [x] OAuth flow.
- [x] CRUD файлов синка.
- [x] Тест на upload/download.

---
## 8) Provider: NAS (WebDAV/SMB)
**Цель:** персональные NAS.

**Checklist**
- [x] WebDAV клиент (минимальный).
- [x] CRUD файлов синка.
- [x] Тест на upload/download.
