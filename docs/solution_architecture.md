Solution Architecture
Интеллектуальная читалка + база знаний + AI

Версия: 1.0 • Дата: 2025-12-16

# 1. Краткое описание

Документ описывает целевую архитектуру (Solution Architecture) приложения для активного чтения: читалка книг/документов, система заметок и персональная база знаний (Knowledge Graph) с AI-ассистентом.

# 2. Current vs Target

## Current (MVP0–MVP3)
- Flutter‑клиент с нативным рендером текста и локальным хранилищем (Hive + app‑managed storage).
- Локальные сущности: библиотека, заметки, выделения, закладки, позиция чтения.
- Event log хранится локально, без синхронизации.
- Backend/AI/Graph отсутствуют в кодовой базе.

## Target (Solution Architecture)
Ниже описан целевой вид системы с backend, синхронизацией и AI‑слоем.

# 3. Цели и принципы

- Кроссплатформенность (mobile/desktop) при единой кодовой базе.

- Модульность и расширяемость: чтение, заметки, синхронизация, AI, граф знаний — независимые подсистемы.

- Offline-first для чтения и заметок с последующей синхронизацией.

- Наблюдаемость и поддерживаемость: трассировка, метрики, ошибки, алерты.

# 4. Финальный техностек

| Компонент | Технология |
| --- | --- |
| Frontend | Flutter |
| Backend API | NestJS |
| AI-сервисы | FastAPI + LangChain |
| Реляционная БД | PostgreSQL |
| Vector DB | Qdrant |
| Graph DB | Neo4j |
| Хранилище файлов | S3-compatible |
| Синхронизация | WebSockets + собственный sync‑gateway |
| DevOps/Observability | Docker + GitHub Actions + Grafana + Sentry |

# 5. System Context

Внешний контекст системы и ключевые интеграции.

![solution_architecture diagram] assets/solution_architecture_01.png

# 6. Логическая архитектура

Высокоуровневая схема слоёв и ответственность компонентов на клиенте (Clean Architecture).

![solution_architecture diagram] assets/solution_architecture_02.png

# 7. Потоки данных

Основные потоки: загрузка/чтение, заметки, синхронизация, вызовы AI и обновление графа знаний.

![solution_architecture diagram] assets/solution_architecture_03.png

# 8. AI-пайплайн

AI-слой выполняет: разбиение текста на чанки, эмбеддинги, retrieval контекста, генерацию summary/объяснений, и запись результатов в Knowledge Graph.

![solution_architecture diagram] assets/solution_architecture_04.png

# 9. Knowledge Graph и модель знаний

База знаний объединяет сущности книги/глав/цитат/заметок и концепты (Concept), формируя граф связей. Часть данных хранится реляционно (PostgreSQL), часть — в Neo4j; семантический поиск — в Qdrant.

![solution_architecture diagram] assets/solution_architecture_05.png

# 10. Хранилища данных и стратегия persistence

- PostgreSQL: пользователи, библиотека, метаданные, заметки/аннотации, состояния чтения, задания на обработку.

- S3-compatible: книги/файлы, обложки, экспорт/бэкапы, артефакты AI (по необходимости).

- Qdrant: embeddings чанков, заметок, концептов для retrieval и рекомендаций.

- Neo4j: Knowledge Graph (узлы/связи), путь знаний, рекомендации по темам.

# 11. Безопасность

- Аутентификация/авторизация: JWT/OAuth2 (в зависимости от стратегии аккаунтов).

- Шифрование: TLS везде; опционально — client-side encryption для приватной библиотеки.

- Мульти-тенантность: строгая изоляция данных по user_id/tenant_id на уровне БД и сервисов.

- Аудит: логирование критичных операций (удаление, экспорт, доступ к данным).

# 12. Наблюдаемость и эксплуатация

- Grafana: метрики (latency, error rate, throughput), дашборды по сервисам.

- Sentry: ошибки клиента/сервера, релиз-трекинг.

- Трассировка: OpenTelemetry (рекомендуется) между NestJS и FastAPI.

- Логи: структурированные, корреляция по request_id/trace_id.

# 13. Deployment view

Рекомендованный вариант развертывания для self-hosted и облака.

![solution_architecture diagram] assets/solution_architecture_06.png

# 14. Масштабирование и производительность

- Горизонтальное масштабирование NestJS и FastAPI (stateless) за LB.

- Очереди задач для AI (рекомендуется добавить Redis+BullMQ или RabbitMQ) — генерация summary/embeddings асинхронно.

- Кэширование: Redis для сессий, rate-limit, горячих запросов.

- Индексирование и денормализация для быстрых списков (библиотека/поиск/история).

# 15. Риски и меры

- Стоимость LLM и латентность → батчинг, кэш, режимы качества, локальные модели в перспективе.

- Консистентность между PostgreSQL/Neo4j/Qdrant → событийная модель и idempotent-процессы обновления.

- Сложность синхронизации → конфликт-стратегии (CRDT/last-write-wins) для заметок/тегов.

# 16. Roadmap (укрупненно)

1. Phase 1 (MVP): читалка + импорт книг + базовое AI-summary.

1. Phase 2: заметки + синхронизация + поиск.

1. Phase 3: Knowledge Graph + связи + рекомендации.

1. Phase 4: расширенные AI-объяснения, персонализация, аналитика.

1. Phase 5: офлайн/edge-модель на устройстве.
