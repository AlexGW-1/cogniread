## Программа ручного тестирования — Milestone 2 (Global Search v2)

Дата: 2026-01-19  
Статус: подготовлено (ручное тестирование не выполнялось во время разработки)

### 1) Цели

- Проверить работоспособность Global Search v2: FTS‑поиск по Books/Notes/Quotes, UI состояния, rebuild индекса, jump-to-anchor.
- Проверить инкрементальные обновления индекса при import/delete/mark changes/sync reconcile.
- Убедиться, что ранее протестированные пользовательские сценарии не сломаны (регрессия).

### 2) Объём (Scope)

**Входит**
- Global Search v2 (bottom sheet из Library).
- Search Index: SQLite/FTS5, rebuild, status/diagnostics, обработка ошибок.
- Jump-to-location: переход в Reader по anchor/mark.

**Не входит**
- Веб‑платформа (SQLite/FTS для web не поддерживается).
- Семантический поиск/эмбеддинги.

### 3) Подготовка окружения

- Платформы (минимум): macOS desktop + один mobile (iOS/Android) если доступно.
- Сборка: `flutter run` (debug) и (по возможности) release.
- Очистка: перед началом теста желательно удалить локальные данные приложения (или использовать отдельный профиль/симулятор).
- Навигация на mobile: основные разделы (Поиск/Настройки) доступны через нижнюю навигацию.

### 4) Тестовые данные (Dataset)

Подготовить набор из минимум 3 книг:
- **Book A**: короткая (1–3 главы), уникальные слова для поиска (например `alphaOmega`).
- **Book B**: средняя, повторяющиеся слова в разных главах (для проверки ранжирования/детерминизма).
- **Book C**: большая (много текста), для проверки UX при длинном индексе.

Для каждой книги создать:
- 1–2 заметки (Note) с уникальным словом (например `noteTokenA`).
- 1–2 выделения (Highlight) с уникальным словом (например `quoteTokenA`).

Можно использовать любые EPUB; для удобства в репозитории есть тестовые `.epub` в `test/` (их можно импортировать через UI).

### 5) Порядок выполнения (Smoke → Full → Regression)

Рекомендуемый порядок:
1) Smoke (P0): открытие поиска, базовые результаты, переход в Reader.
2) Full функциональные кейсы: rebuild/diagnostics/инкрементальные апдейты.
3) Регрессия ранее протестированных сценариев.

---

## A. Smoke / P0 (обязательно)

### A1 — Открытие Global Search v2

**Шаги**
1. Открыть экран Library.
2. Нажать кнопку глобального поиска (иконка “Глобальный поиск” в AppBar или раздел “Поиск” в нижней навигации).

**Ожидаемо**
- Открывается bottom sheet “Поиск”.
- Фокус в поле ввода, клавиатура открывается на mobile.
- Tabs отображаются: Books / Notes / Quotes.

### A2 — Empty state

**Шаги**
1. Открыть Global Search.
2. Убедиться, что поле пустое.

**Ожидаемо**
- Сообщение “Введите запрос для поиска.”
- Нет падений/ошибок.

### A3 — Books search: результаты и стабильность

**Шаги**
1. Вкладка Books.
2. Ввести запрос, который есть в тексте Book A (например `alphaOmega`).

**Ожидаемо**
- Появляется прогресс во время поиска (не блокирует UI).
- Возвращаются результаты (ListTile с названием книги).
- В subtitle отображается snippet (с подсветкой совпадений).
- При быстром наборе/удалении текста UI не “залипает”, не падает.

### A4 — Jump-to-anchor по результату Books

**Шаги**
1. Вкладка Books.
2. Нажать на любой результат.

**Ожидаемо**
- Bottom sheet закрывается.
- Открывается Reader нужной книги.
- Позиция примерно соответствует найденному месту (в пределах главы/абзаца).

### A5 — Notes tab: поиск и переход

**Шаги**
1. Открыть Global Search → вкладка Notes.
2. Ввести запрос по тексту заметки (например `noteTokenA`).
3. Нажать на результат.

**Ожидаемо**
- Открывается Reader этой книги.
- Скролл к заметке/окрестности.

### A6 — Quotes tab: поиск и переход

**Шаги**
1. Открыть Global Search → вкладка Quotes.
2. Ввести запрос по выделению (например `quoteTokenA`).
3. Нажать на результат.

**Ожидаемо**
- Открывается Reader этой книги.
- Скролл к выделению/окрестности.

---

## B. Functional (M2 покрытие)

### B1 — Инкрементальная индексация после импорта (без rebuild)

**Шаги**
1. Удалить/очистить библиотеку (если это безопасно для окружения теста).
2. Импортировать Book A.
3. Сразу открыть Global Search → Books и найти слово из текста.

**Ожидаемо**
- Результаты появляются без ручного rebuild индекса.

### B2 — Инкрементальная индексация marks (note/highlight)

**Шаги**
1. Открыть Book A в Reader.
2. Создать highlight и note (с уникальным словом).
3. Закрыть Reader → открыть Global Search → Notes/Quotes, поискать эти слова.

**Ожидаемо**
- Новые note/highlight находятся без rebuild.

### B3 — Удаление книги удаляет результаты из индекса

**Шаги**
1. Убедиться, что Book A находится в Global Search (Books/Notes/Quotes).
2. Удалить Book A из Library.
3. Повторить поиск по словам, которые раньше находились.

**Ожидаемо**
- Результаты по удалённой книге отсутствуют.

### B4 — Diagnostics: статус индекса в Settings

**Шаги**
1. Открыть Settings (на mobile: нижняя навигация “Настройки”) → раздел “Диагностика”.
2. Найти блок “Search index”.
3. Нажать “Обновить”.

**Ожидаемо**
- Видно: schema version, rows counts (books/marks), время rebuild (если было), путь к DB (если доступен).
- Нет ошибок/исключений в UI.

### B5 — Rebuild index из Settings

**Шаги**
1. Settings → “Search index”.
2. Нажать “Перестроить”.
3. После завершения повторить поиск в Global Search.

**Ожидаемо**
- Показывается прогресс в кнопке.
- После завершения: snackbar “Индекс перестроен”.
- Поиск продолжает работать, результаты не деградируют.

### B6 — Ranking/детерминизм

**Шаги**
1. Подготовить 2 книги:
   - у одной слово встречается в title,
   - у другой слово встречается только в content.
2. Поискать это слово в Books.
3. Повторить поиск 5–10 раз (в т.ч. после перезапуска приложения).

**Ожидаемо**
- Вверху выдачи (обычно) книга с совпадением в title.
- При одинаковом запросе порядок результатов стабилен.

### B7 — Reconcile после sync (если sync настроен)

**Шаги**
1. Выполнить sync.
2. Убедиться, что после sync поиск по книгам/marks соответствует текущей библиотеке.

**Ожидаемо**
- Нет “призрачных” результатов для удалённых книг.
- Новые/обновлённые книги появляются в поиске без ручного rebuild (или после reconcile).

---

## C. Регрессия (ранее протестированные сценарии)

### C1 — Library: локальный поиск и отображение

**Шаги**
1. В Library включить/выключить локальный поиск по библиотеке.
2. Проверить list/grid переключение.

**Ожидаемо**
- Фильтрация книг работает.
- UI не ломается после использования Global Search v2.

### C2 — Reader: базовый поток чтения

**Шаги**
1. Открыть книгу.
2. Пролистать, выделить текст, создать highlight, создать note.
3. Открыть список заметок/выделений, перейти по ним.

**Ожидаемо**
- Ничего не сломано: контент отображается, marks работают.

### C3 — Reader: in-book search

**Шаги**
1. В Reader открыть поиск по книге.
2. Найти слово, перейти по результатам.

**Ожидаемо**
- Поиск по книге работает, переход по результатам позиционирует текст.

### C4 — Bookmarks / TOC

**Шаги**
1. Добавить/удалить bookmark, открыть список bookmarks.
2. Открыть TOC, перейти к главе.

**Ожидаемо**
- Переходы работают, позиционирование корректное.

### C5 — Sync flow (если ранее тестировалось)

**Шаги**
1. Settings → подключение провайдера (если есть конфиг).
2. “Проверить” соединение.
3. “Синхронизировать сейчас”.
4. Проверить, что логика “подключить/отключить/переподключить” работает.

**Ожидаемо**
- Нет регрессии в UI/ошибках.

### C6 — Логи/диагностика приложения

**Шаги**
1. Settings → “Диагностика”.
2. “Копировать путь”, “Открыть папку”, “Экспорт лога”.

**Ожидаемо**
- Действия выполняются без падений.

---

## 6) Критерии приёмки (Exit Criteria)

- Все кейсы A (P0) пройдены на минимум одной платформе.
- Ключевые кейсы B1–B5 пройдены на минимум одной платформе.
- Регрессия C1–C4 пройдена.
- Все найденные дефекты заведены/зафиксированы (с шагами воспроизведения и логами).

## 7) Артефакты и отчётность

- Скриншоты/видео для критичных дефектов.
- Путь к логу и экспортированный лог (если падение/ошибка).
- Для Search index: скрин/текст статуса из “Search index” блока (schema/rows/lastError/dbPath).
